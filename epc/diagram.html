<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPC - Parts & Diagram</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3C!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--%3E%3Cpath fill='%23fff' opacity='1' d='M430.5 284.4l-31.82-79.54C383.7 177.6 357.7 160 328.4 160H183.6C154.3 160 128.3 177.6 117.4 204.8l-31.82 79.56C62.88 301.1 48 329.2 48 360V480c0 17.67 14.33 32 32 32H96c17.67 0 32-14.33 32-32v-32h288v32c0 17.67 14.33 32 32 32s32-14.33 32-32v-120C464 329.2 449.1 301.1 426.4 284.4zM161.9 222.7C165.5 213.8 174 208 183.6 208h144.8c9.598 0 18.1 5.76 21.66 14.66L366.6 264H145.4L161.9 222.7zM416 400H96v-40c0-26.47 21.53-48 48-48h224c26.47 0 48 21.53 48 48V400zM505.9 111.1H447.8l-21.37-31.1l21.37-31.1h58.14c4.619 0 7.619-5.048 5.246-9.001C497.2 15.66 471.7 0 442.4 0c-32.79 0-60.59 19.86-73.01 48H142.8C131.9 23.19 108.6 4.574 80.9 .7793c-33.87-4.641-64.28 11.89-80.05 38.19c-2.381 3.955 .6094 9.034 5.24 9.034H64.22l21.37 31.1L64.22 112H6.078c-4.619 0-7.619 5.047-5.246 9.002C14.82 144.3 40.33 160 69.57 160c32.79 0 60.59-19.86 73.01-47.1h226.6c10.97 24.81 34.23 43.43 61.94 47.22c33.87 4.641 64.28-11.89 80.05-38.19C513.5 117.1 510.5 111.1 505.9 111.1zM160 336c-13.25 0-24 10.74-24 24C136 373.3 146.7 384 160 384s24-10.75 24-24C184 346.7 173.3 336 160 336zM352 336c-13.25 0-24 10.74-24 24c0 13.25 10.75 24 24 24s24-10.75 24-24C376 346.7 365.3 336 352 336z'/%3E%3Cpath fill='white' opacity='0.4' d='M511.2 121c-15.77 26.3-46.18 42.83-80.05 38.19c-27.7-3.795-50.96-22.41-61.94-47.22H142.6C130.2 140.1 102.4 160 69.57 160C40.33 160 14.82 144.3 .832 121C-1.541 117 1.459 112 6.078 112H64.22l21.37-31.1L64.22 48H6.09c-4.631 0-7.621-5.068-5.24-9.034c15.77-26.3 46.18-42.83 80.05-38.19c27.7 3.795 50.96 22.41 61.94 47.22h226.6C381.8 19.86 409.6 0 442.4 0c29.23 0 54.75 15.66 68.73 38.1c2.373 3.955-.627 9.001-5.246 9.001H447.8l-21.37 31.1l21.37 31.1h58.13C510.5 111.1 513.5 117.1 511.2 121z'/%3E%3C/svg%3E">
    <style>
    html, body {
      height: 100%;
      width: 100vw;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background: #f4f4f9;
      transition: background-color 0.3s;
    }
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .epc-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      flex-shrink: 0;
    }
    .epc-header-left {
      display: flex;
      align-items: center;
      gap: 0.9rem;
    }
    .epc-header h1 {
      font-size: 1.6rem;
      font-weight: 700;
      color: #121212;
      margin: 0;
    }
    .epc-header-actions {
      display: flex;
      align-items: center;
      gap: 0.7rem;
    }
    .epc-header-home {
      display: inline-block;
      padding: 0.6rem 1.4rem;
      font-size: 1.14rem;
      font-weight: 600;
      color: #6c757d;
      border: 1.5px solid #dee2e6;
      border-radius: 8px;
      text-decoration: none;
      transition: background 0.18s, color 0.18s, border 0.18s;
      letter-spacing: 0.01em;
    }
    .epc-header-home:hover {
      color: #007bff;
      border-color: #007bff;
    }
    .epc-theme-toggle {
        background: #fff;
        border: 1.5px solid #dee2e6;
        border-radius: 50%;
        cursor: pointer;
        width: 44px; height: 44px;
        display: flex; justify-content: center; align-items: center;
        color: #6c757d;
        font-size: 1.2rem;
        transition: background-color 0.3s, border-color 0.3s;
    }
    #main-app-content {
      flex-grow: 1;
      display: flex;
      flex-direction: row;
      gap: 2rem;
      width: 100vw;
      height: calc(100vh - 150px);
      min-height: 0;
      padding: 0 1.5vw 1.5vw 1.5vw;
      box-sizing: border-box;
      overflow: hidden;
    }
    #diagram-container,
    #parts-table-wrapper {
      height: 100%; margin: 0; padding: 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      background: #fff;
      overflow: hidden;
      min-width: 350px;
      display: flex;
      flex-direction: column;
    }
    #diagram-container {
      max-width: 50vw;
      margin-right: 1rem;
      background: #f8f8f8;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    #diagram-wrapper {
      position: relative; width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      transform-origin: top left;
      cursor: grab; user-select: none;
    }
    #diagram-wrapper.dragging { cursor: grabbing; }
    #diagram {
      display: block; width: 100%; height: 100%;
      max-width: 100%; object-fit: contain; margin: 0 auto;
    }
    #callouts-layer { position: absolute; }
    .callout {
      position: absolute;
      width: 20px; height: 20px;
      background-color: rgba(255, 0, 0, 0.42);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      cursor: pointer; pointer-events: auto; z-index: 10;
      transition: background-color 0.15s, border 0.15s;
      border: 2px solid rgba(0,0,0,0.13);
      box-shadow: 0 2px 8px 0 rgba(0,0,0,0.09);
    }
    .callout:hover { background-color: rgba(255, 45, 45, 0.45); }
    .callout.active {
      background-color: rgba(23, 147, 255, 0.42);
      border: 2.5px solid #055b8c;
      box-shadow: 0 2px 12px 0 rgba(23,147,255,0.15);
    }
    #controls {
      position: absolute; top: 10px; left: 10px; z-index: 20;
      background: rgba(255, 255, 255, 0.8);
      padding: 5px; border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    #controls button {
      padding: 5px 10px; margin-right: 5px;
      cursor: pointer; border: 1px solid #ccc;
      border-radius: 3px; background-color: #f0f0f0; color: #333;
    }
    #controls button:hover { background-color: #e0e0e0; }
    #parts-table-wrapper {
      max-width: 58vw; min-width: 380px;
      overflow-y: auto; flex: 1 1 0; background: #fff;
    }
    #parts-table {
      width: 100%;
      border-collapse: collapse;
      cursor:pointer;
      table-layout: fixed;
    }
    #parts-table th, #parts-table td {
      padding: 0.6rem;
      text-align: left;
      font-size: 0.9em;
      overflow-wrap: break-word;
    }
    #parts-table thead th {
      position: sticky; top: 0;
      background-color: #003366; color: white; z-index: 1;
    }
    #parts-table tbody tr:nth-child(even) { background-color: #f9f9f9; }
    #parts-table tbody tr:hover { background-color: #e0f0ff; }
    tr.highlight { background-color: #ffe68b !important; }
    .col-call { width: 5%; }
    .col-part { width: 15%; }
    .col-desc { width: 35%; }
    .col-usage { width: 20%; }
    .col-range { width: 15%; }
    .col-qty { width: 5%; }
    .col-details { width: 5%; }
    .breadcrumb {
      display: flex; flex-wrap: wrap;
      padding: 0.5rem 1rem;
      list-style: none;
      background-color: #e9ecef;
      border-radius: 0.25rem;
      font-size: 0.9rem;
      color: #003366;
      margin: 0 1rem 1rem 1rem;
    }
    .breadcrumb-item + .breadcrumb-item::before {
      content: "›"; padding: 0 0.5rem; color: #6c757d;
      user-select: none; font-weight: 700; font-size: 1rem;
    }
    .breadcrumb-item a { color: #003366; text-decoration: none; cursor: pointer; }
    .breadcrumb-item a:hover { text-decoration: underline; }
    .breadcrumb-item.active { color: #555; font-weight: 600; }
    @media (max-width: 1700px), (max-aspect-ratio: 3/4) {
      #main-app-content { flex-direction: column; height: auto; gap: 0.8rem; padding: 0 0.5rem 0.5rem 0.5rem; width: 100%; min-width: 0; box-sizing: border-box; overflow-x: hidden; }
      #diagram-container { width: 100%; max-width: 100%; min-width: 0; margin-right: 0; height: 50vh; min-height: 180px; overflow-x: hidden; box-sizing: border-box; }
      #diagram-wrapper { width: 100%; height: 100%; overflow-x: hidden; box-sizing: border-box; display: flex; align-items: center; justify-content: center; }
      #diagram { width: 100% !important; max-width: 100%; height: 100%; object-fit: contain; display: block; }
      #parts-table-wrapper { width: 100%; max-width: 100%; min-width: 0; margin-top: 1rem; padding: 0; overflow-x: auto; background: #fff; height: auto; min-height: 180px; box-sizing: border-box; }
      #parts-table { max-width: none; table-layout: auto; display: table; }
    }
    body[data-bs-theme="dark"] { background: #212529; color: #e1e9f7; }
    body[data-bs-theme="dark"] .epc-header h1 { color: #dee2e6; }
    body[data-bs-theme="dark"] .epc-header-home, body[data-bs-theme="dark"] .epc-theme-toggle { border-color: #6c757d; color: #adb5bd; }
    body[data-bs-theme="dark"] #diagram-container { background: #1a1a1a; }
    body[data-bs-theme="dark"] .breadcrumb { background: #495057; color:#c7d7ef; }
    body[data-bs-theme="dark"] #parts-table-wrapper { background: #181818; }    
    body[data-bs-theme="dark"] .breadcrumb-item a { color: #c7d7ef; }   
    body[data-bs-theme="dark"] .epc-theme-toggle { background: #181818; }
    body[data-bs-theme="dark"] #parts-table thead th { background-color: #52789b; }
    body[data-bs-theme="dark"] #parts-table tbody tr:nth-child(even) { background-color: #2a2a2a; }
    body[data-bs-theme="dark"] #parts-table tbody tr:hover { background-color: #25344a; }
    body[data-bs-theme="dark"] .breadcrumb-item.active { color: #fff; }
    body[data-bs-theme="dark"] tr.highlight { background-color: #b3a061 !important; }
    body[data-bs-theme="dark"] [data-invert-in-dark="true"] { filter: invert(1) hue-rotate(180deg); }
    #details-modal { position: fixed; left:0; top:0; width:100vw; height:100vh; background: rgba(0,0,0,0.32); z-index: 9999; display: none; align-items: center; justify-content: center; animation: fadeIn 0.2s; }
    .details-modal-dialog { max-height: 98vh; display: flex; flex-direction: column; background: white; border-radius: 10px; width: 900px; max-width: 94vw; box-shadow: 0 8px 36px #0002; margin: auto; position: relative; animation: slideUp 0.2s; }
    .details-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.1rem 1.6rem; border-bottom: 1px solid #eee; }
    .details-modal-main { flex: 1 1 auto; display: flex; flex-direction: column; padding: 0 1.6rem 1rem; }
    #details-modal-title { font-size: 1.14em; font-weight: bold; color: #003366; }
    .details-modal-close { font-size: 1.6em; background: none; border: none; cursor: pointer; color: #888; }
    .details-modal-table { width: 100%; margin-top: 1rem; border-collapse: collapse; font-size: 1em; }
    .details-modal-table th { text-align: left; color: #555; width: 100px; padding: 6px 7px; background: #f8fafc; }
    .details-modal-table td { color: #222; padding: 6px 7px; }
    .details-modal-tabs { display: flex; gap: 0.5rem; margin-top: 1rem; }
    .details-modal-tabs button { background: #f5f7fa; border: none; border-radius: 6px 6px 0 0; padding: 0.5em 1.2em; cursor: pointer; font-weight: 500; color: #003366; border-bottom: 2px solid transparent; transition: background 0.12s; }
    .details-modal-tabs button.active { background: #fff; border-bottom: 2px solid #003366; color: #0d356b; }
    .tab-content-outer { background: #fff; border: 1px solid #e0e6ef; border-radius: 0 7px 7px 7px; margin-top: -1px; box-shadow: 0 2px 8px #0001; flex: 1 1 auto; display: flex; min-height: 180px; }
    #details-modal-tab-content { width: 100%; padding: 1.1em 1.4em; font-size: 1.05em; box-sizing: border-box; background: #fff; border-radius: 7px; overflow-y: auto; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(40px); } to { transform: none; } }
    /* Dark Theme Modal Styles */
    body[data-bs-theme="dark"] .details-modal-dialog { background: #2c3034; border-color: #495057; }
    body[data-bs-theme="dark"] .details-modal-header { border-bottom-color: #495057; }
    body[data-bs-theme="dark"] #details-modal-title { color: #eaf1ff; }
    body[data-bs-theme="dark"] .details-modal-close { color: #adb5bd; }
    body[data-bs-theme="dark"] .details-modal-table th { background: #212529; color: #adb5bd; }
    body[data-bs-theme="dark"] .details-modal-table td { color: #e1e9f7; }
    body[data-bs-theme="dark"] .details-modal-tabs button { background: #212529; color: #c7d7ef; }
    body[data-bs-theme="dark"] .details-modal-tabs button.active { background: #2c3034; border-bottom-color: #0d6efd; color: #eaf1ff; }
    body[data-bs-theme="dark"] .tab-content-outer { background: #2c3034; border-color: #495057; }
    body[data-bs-theme="dark"] #details-modal-tab-content { background: #2c3034; }
    body[data-bs-theme="dark"] #diagram {
    filter: invert(0.92) grayscale(0.72) brightness(1.11) contrast(0.97) hue-rotate(208deg);
    transition: filter 0.3s;
    background: #1a2233;
}
/* --- DARK MODE CUSTOM SCROLLBARS --- */
body[data-bs-theme="dark"] ::-webkit-scrollbar {
    width: 12px;
    background: #23272e;
}
body[data-bs-theme="dark"] ::-webkit-scrollbar-thumb {
    background: #3d434e;
    border-radius: 8px;
    border: 2px solid #23272e;
}
body[data-bs-theme="dark"] ::-webkit-scrollbar-thumb:hover {
    background: #596080;
}
body[data-bs-theme="dark"] ::-webkit-scrollbar-corner {
    background: #23272e;
}

/* Firefox (newer versions) */
body[data-bs-theme="dark"] {
    scrollbar-color: #3d434e #23272e;
    scrollbar-width: thin;
}

    </style>
</head>
<body>
    <div class="epc-header">
        <div class="epc-header-left">
            <img id="model-logo" style="height: 50px; display: none;" alt="Model Logo">
            <h1>Electronic Parts Catalogue</h1>
        </div>
        <div class="epc-header-actions">
            <a href="#" id="epc-home-btn" class="epc-header-home">‹ Home</a>
            <button id="theme-toggle" class="epc-theme-toggle" title="Toggle light/dark mode">
                <span class="moon-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width:20px;height:20px;fill:currentColor;"><path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
                </span>
                <span class="sun-icon" style="display:none;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width:20px;height:20px;fill:currentColor;"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.64 5.64c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41zm12.72 12.72c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41zM5.64 18.36c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41zM18.36 5.64c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41z"/></svg>
                </span>
            </button>
        </div>
    </div>
    
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb" id="epc-breadcrumb"></ol>
    </nav>
    
    <div id="error-message" style="display:none"></div>

    <div id="main-app-content">
        <div id="diagram-container">
            <div id="controls">
                <button id="zoom-in">+</button>
                <button id="zoom-out">-</button>
                <button id="reset">Reset</button>
            </div>
            <div id="diagram-panzoom" style="position:relative; width:100%; height:100%;">
                <div id="diagram-wrapper" tabindex="-1">
                    <img id="diagram" src="" alt="Diagram" draggable="false" tabindex="-1">
                    <div id="callouts-layer"></div>
                </div>
            </div>
        </div>
        <div id="parts-table-wrapper">
            <table id="parts-table">
                <thead>
                    <tr>
                        <th class="col-call">#</th>
                        <th class="col-part">Part#</th>
                        <th class="col-desc">Description</th>
                        <th class="col-usage">Usage</th>
                        <th class="col-range">Range</th>
                        <th class="col-qty">Qty</th>
                        <th class="col-details">Details</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    
    <!-- DEV-ONLY BUTTON. KEEP OR REMOVE AS NEEDED. -->
    <button id="toggle-coord-picker" style="position:absolute; top:10px; right:10px; z-index:1000; display:none;">Enable Coord Picker</button>
    
    <div id="details-modal" style="display:none;">
      <div class="details-modal-dialog">
        <div class="details-modal-header">
          <span id="details-modal-title"></span>
          <button id="close-details-modal" class="details-modal-close">×</button>
        </div>
        <div class="details-modal-main"></div>
      </div>
    </div>











    <!-- The single, consolidated script that handles everything -->

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- UNIVERSAL HELPER FUNCTIONS ---
        function isElectron() { return navigator.userAgent.toLowerCase().indexOf(' electron/') > -1; }
        function getRootPath() { 
            if (window.location.pathname.includes('/epc/')) { return '../'; }
            return './'; 
        }

        // --- UNIVERSAL THEME LOGIC ---
        function setTheme(theme) {
          const effectiveTheme = theme || 'light';
          document.body.classList.toggle('dark-theme', effectiveTheme === 'dark');
          document.body.setAttribute('data-bs-theme', effectiveTheme);
          localStorage.setItem('theme', effectiveTheme);
          updateThemeIcon();
        }
        function updateThemeIcon() {
          const isDark = document.body.getAttribute('data-bs-theme') === 'dark';
          document.querySelectorAll('#theme-toggle').forEach(btn => {
            const moon = btn.querySelector('.moon-icon'); 
            const sun = btn.querySelector('.sun-icon');
            if (moon && sun) {
              moon.style.display = isDark ? 'none' : 'inline-block';
              sun.style.display = isDark ? 'inline-block' : 'none';
            }
          });
        }

        // --- UNIVERSAL MASTER EVENT LISTENER ---
        document.body.addEventListener('click', function(e) {
          const homeLink = e.target.closest('.epc-header-home');
          const themeToggleButton = e.target.closest('#theme-toggle');
          if (homeLink) {
            e.preventDefault(); 
            const root = getRootPath();
            if (isElectron()) { window.location.href = root + 'app-home.html'; } 
            else { window.location.href = root + 'index.html'; }
          }
          if (themeToggleButton) {
            const current = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
            setTheme(current === 'dark' ? 'light' : 'dark');
          }
        });

        // --- PAGE-SPECIFIC LOGIC for diagram.html ---
        const rootPath = getRootPath();
        const urlParams = new URLSearchParams(window.location.search);
        
        // Logo Loader Logic
        const brandCodeLogo = urlParams.get('brand');
        const logoImg = document.getElementById('model-logo');
        if (brandCodeLogo && logoImg) {
            fetch(`${rootPath}data/brands.json`)
              .then(resp => resp.json())
              .then(brands => {
                const brand = brands.find(b => b.code.toUpperCase() === brandCodeLogo.toUpperCase());
                if (brand && brand.logo) {
                  logoImg.src = brand.logo;
                  logoImg.style.display = 'block';
                  logoImg.alt = brand.name + " logo";
                  if (brand.invertInDark === true) {
                    logoImg.setAttribute('data-invert-in-dark', 'true');
                  }
                }
              });
        }

        // BREADCRUMB LOGIC (Self-contained and corrected)
(function() {
    const breadcrumbEl = document.getElementById('epc-breadcrumb');
    if (!breadcrumbEl) return;

    const brandCode = urlParams.get('brand');
    const modelCode = urlParams.get('model');
    const sectionCode = urlParams.get('section');
    const subsectionCode = urlParams.get('subsection');
    const detailCode = urlParams.get('detail');

    if (!brandCode || !modelCode) return;

    let detailsListFile = null;
    if (detailCode && sectionCode) {
        const detailsFileSegment = subsectionCode ? `${sectionCode}_${subsectionCode}` : sectionCode;
        detailsListFile = `${rootPath}data/brands/${brandCode}/${modelCode}/details_${detailsFileSegment}.json`;
    }

    Promise.all([
        fetch(`${rootPath}data/brands.json`).then(res => res.ok ? res.json() : null),
        fetch(`${rootPath}data/brands/${brandCode}/models.json`).then(res => res.ok ? res.json() : null),
        fetch(`${rootPath}data/brands/${brandCode}/${modelCode}/sections.json`).then(res => res.ok ? res.json() : null),
        subsectionCode ? fetch(`${rootPath}data/brands/${brandCode}/${modelCode}/subsections_${sectionCode}.json`).then(res => res.ok ? res.json() : null) : Promise.resolve(null),
        detailsListFile ? fetch(detailsListFile).then(res => res.ok ? res.json() : null) : Promise.resolve(null)
    ]).then(([brands, modelsData, sections, subsections, detailsList]) => {
        const brand = brands?.find(b => b.code.toLowerCase() === brandCode);
        const model = modelsData ? modelsData[brandCode]?.find(m => m.code.toLowerCase() === modelCode) : null;
        const section = sections?.find(s => s.code === sectionCode);
        const subsection = subsections?.find(s => s.code === subsectionCode);
        const detail = detailsList?.find(d => d.code === detailCode);

        breadcrumbEl.innerHTML = '';
        const epcUrlBase = `${rootPath}epc/epc.html`;
        const homeUrl = `${rootPath}epc/index.html`;

        breadcrumbEl.innerHTML += `<li class="breadcrumb-item"><a href="${homeUrl}">EPC</a></li>`;

        // Brand
        if (brand) {
            const brandUrl = `${epcUrlBase}?brand=${encodeURIComponent(brandCode)}`;
            breadcrumbEl.innerHTML += `<li class="breadcrumb-item"><a href="${brandUrl}">${brand.name}</a></li>`;
        }

        // Model
        if (model) {
            const modelUrl = `${epcUrlBase}?brand=${encodeURIComponent(brandCode)}&model=${encodeURIComponent(modelCode)}`;
            breadcrumbEl.innerHTML += `<li class="breadcrumb-item"><a href="${modelUrl}">${model.name}</a></li>`;
        }

        // Section
        if (section) {
            const sectionUrl = `${epcUrlBase}?brand=${encodeURIComponent(brandCode)}&model=${encodeURIComponent(modelCode)}&section=${encodeURIComponent(sectionCode)}&highlight=${encodeURIComponent(sectionCode)}`;
            breadcrumbEl.innerHTML += `<li class="breadcrumb-item"><a href="${sectionUrl}">${section.name}</a></li>`;
        }

        // Subsection
        if (subsection) {
            const subsectionUrl = `${epcUrlBase}?brand=${encodeURIComponent(brandCode)}&model=${encodeURIComponent(modelCode)}&section=${encodeURIComponent(sectionCode)}&subsection=${encodeURIComponent(subsectionCode)}&highlight=${encodeURIComponent(subsectionCode)}`;
            breadcrumbEl.innerHTML += `<li class="breadcrumb-item"><a href="${subsectionUrl}">${subsection.name}</a></li>`;
        }

        // Detail (current page, not a link)
        if (detail) {
            breadcrumbEl.innerHTML += `<li class="breadcrumb-item active" aria-current="page">${detail.name}</li>`;
        }
    }).catch(err => console.error("Error building breadcrumb:", err));
})();



        // DIAGRAM AND PARTS LOGIC
        let currentlyHighlightedCall = null; 
        const diagramContainer = document.getElementById('diagram-container');
        const diagramWrapper = document.getElementById('diagram-wrapper');
        const diagram = document.getElementById('diagram');
        const calloutsLayer = document.getElementById('callouts-layer');
        const partsTableBody = document.querySelector('#parts-table tbody');
        const panzoom = document.getElementById('diagram-panzoom');
        let scale = 1, panX = 0, panY = 0, isDragging = false, lastMouseX = 0, lastMouseY = 0;
        
        function showDetailsModal(part) { 
            var elTitle = document.getElementById('details-modal-title'); 
            var elMain = document.querySelector('#details-modal .details-modal-main'); 
            var modal = document.getElementById('details-modal'); 
            if (!elTitle || !elMain || !modal) return; 
            elTitle.textContent = "Part Details: " + (part.part || ""); 
            let reachContent = (part.reach && Array.isArray(part.reach) && part.reach.length) ? '<ul>' + part.reach.map(item => `<li>${Array.isArray(item) ? item.join(" ") : item}</li>`).join('') + '</ul>' : "<div style='color:#888'>No REACH data available.</div>"; 
            let historyContent = part.history ? (Array.isArray(part.history) ? `<table style="width:100%; border-collapse: collapse;"><tr><th style="text-align:left; padding:4px; border-bottom:1px solid #eee;">Part #</th><th style="text-align:left; padding:4px; border-bottom:1px solid #eee;">Description</th></tr>${part.history.map(row => `<tr><td style="padding:4px;">${row.part || ''}</td><td style="padding:4px;">${row.desc || ''}</td></tr>`).join('')}</table>` : `<p>${part.history}</p>`) : "<div style='color:#888'>No history data available.</div>"; 
            elMain.innerHTML = `<table class="details-modal-table"><tr><th>Part #</th><td>${part.part || ''}</td><th>Description</th><td>${part.desc || ''}</td></tr><tr><th>Callout #</th><td>${part.call || ''}</td><th>Usage</th><td>${part.usage || ''}</td></tr><tr><th>Location</th><td>${part.location || part.loc || ''}</td><th>Range</th><td>${part.range || ''}</td></tr></table><div class="details-modal-tabs"><button id="tab-reach" class="active">REACH</button><button id="tab-history">History</button></div><div class="tab-content-outer"><div id="details-modal-tab-content">${reachContent}</div></div><div style="text-align:right; padding-top:1rem;"><button id="details-modal-bottom-close" style="min-width: 90px; background: #003366; color: #fff; border: none; border-radius: 5px; padding: 0.7em 1.8em; font-size: 1em; cursor: pointer;">Close</button></div>`; 
            const tabReach = elMain.querySelector('#tab-reach'); 
            const tabHistory = elMain.querySelector('#tab-history'); 
            const tabContent = elMain.querySelector('#details-modal-tab-content'); 
            const bottomClose = elMain.querySelector('#details-modal-bottom-close'); 
            tabReach.onclick = () => { tabContent.innerHTML = reachContent; tabReach.classList.add('active'); tabHistory.classList.remove('active'); }; 
            tabHistory.onclick = () => { tabContent.innerHTML = historyContent; tabHistory.classList.add('active'); tabReach.classList.remove('active'); }; 
            bottomClose.onclick = () => { modal.style.display = 'none'; }; 
            modal.style.display = 'flex'; 
        }

        function clamp(value, min, max) { return Math.max(min, Math.min(value, max)); }
        
        function applyTransform() { 
            if (!diagramContainer || !panzoom) return;
            const imageDisplayedWidth = diagram.clientWidth; 
            const imageDisplayedHeight = diagram.clientHeight; 
            const containerWidth = diagramContainer.clientWidth; 
            const containerHeight = diagramContainer.clientHeight; 
            const currentScaledImageWidth = imageDisplayedWidth * scale; 
            const currentScaledImageHeight = imageDisplayedHeight * scale; 
            let limitX = Math.max(0, currentScaledImageWidth - containerWidth); 
            let limitY = Math.max(0, currentScaledImageHeight - containerHeight); 
            if (currentScaledImageWidth < containerWidth) panX = (containerWidth - currentScaledImageWidth) / 2; 
            else panX = clamp(panX, -limitX, 0); 
            if (currentScaledImageHeight < containerHeight) panY = (containerHeight - currentScaledImageHeight) / 2; 
            else panY = clamp(panY, -limitY, 0); 
            panzoom.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`; 
            panzoom.style.transformOrigin = "top left"; 
        }
        
        function renderPartsTable(parts) { 
            if (!partsTableBody) return;
            partsTableBody.innerHTML = ''; 
            for (let i = 0; i < parts.length; i++) { 
                const part = parts[i]; 
                if (part.hidden) continue; 
                const row = document.createElement('tr'); 
                row.setAttribute('data-call', part.call); 
                row.innerHTML = `<td>${part.call}</td><td>${part.part}</td><td>${part.desc}</td><td>${part.usage || ''}</td><td>${part.range || ''}</td><td>${part.qty || ''}</td><td>${(part.reach || part.history) ? `<button class="part-details-btn" data-part-index="${i}">Details</button>` : ''}</td>`; 
                row.addEventListener('click', () => highlightElements(part.call)); 
                partsTableBody.appendChild(row); 
            } 
            document.querySelectorAll('.part-details-btn').forEach(btn => { 
                btn.onclick = function(e) { 
                    e.stopPropagation(); 
                    const idx = this.dataset.partIndex; 
                    const part = window.currentPartsData[idx]; 
                    showDetailsModal(part); 
                }; 
            }); 
        }
        
        function renderCallouts(parts) { 
            if (!calloutsLayer || !diagramWrapper || !diagram) return;
            calloutsLayer.innerHTML = ''; 
            if (!diagram.naturalWidth || !diagram.naturalHeight) return; 
            const wrapperWidth = diagramWrapper.clientWidth; 
            const wrapperHeight = diagramWrapper.clientHeight; 
            const imgAspect = diagram.naturalWidth / diagram.naturalHeight; 
            const boxAspect = wrapperWidth / wrapperHeight; 
            let drawWidth, drawHeight, offsetX, offsetY; 
            if (imgAspect > boxAspect) { drawWidth = wrapperWidth; drawHeight = wrapperWidth / imgAspect; offsetX = 0; offsetY = (wrapperHeight - drawHeight) / 2; } 
            else { drawWidth = wrapperHeight * imgAspect; drawHeight = wrapperHeight; offsetX = (wrapperWidth - drawWidth) / 2; offsetY = 0; } 
            calloutsLayer.style.position = 'absolute'; 
            calloutsLayer.style.left = `${offsetX}px`; 
            calloutsLayer.style.top = `${offsetY}px`; 
            calloutsLayer.style.width = `${drawWidth}px`; 
            calloutsLayer.style.height = `${drawHeight}px`; 
            calloutsLayer.style.pointerEvents = "none"; 
            for (const part of parts) { 
                let positions = []; 
                if (Array.isArray(part.positions) && part.positions.length) { positions = part.positions; } 
                else if (typeof part.x === 'number' && typeof part.y === 'number') { positions = [{ x: part.x, y: part.y }]; } 
                for (const pos of positions) { 
                    const callout = document.createElement('div'); 
                    callout.className = 'callout'; 
                    callout.setAttribute('data-call', part.call); 
                    callout.style.left = `${(pos.x / diagram.naturalWidth) * drawWidth}px`; 
                    callout.style.top = `${(pos.y / diagram.naturalHeight) * drawHeight}px`; 
                    callout.title = `Callout ${part.call}`; 
                    callout.style.pointerEvents = "auto"; 
                    callout.addEventListener('click', (e) => { 
                        e.stopPropagation(); 
                        if (part.link) { 
                            const params = new URLSearchParams(window.location.search); 
                            if (part.link.section) params.set('section', part.link.section); 
                            if (part.link.subsection) params.set('subsection', part.link.subsection); 
                            if (part.link.detail) params.set('detail', part.link.detail); 
                            if (part.link.call) params.set('highlight', part.link.call); 
                            window.location.search = params.toString(); 
                            return; 
                        } 
                        highlightElements(part.call); 
                    }); 
                    calloutsLayer.appendChild(callout); 
                } 
            } 
        }
        
        function highlightElements(callNumToHighlight, forceOn = false) { 
            document.querySelectorAll('.callout').forEach(c => c.classList.remove('active')); 
            document.querySelectorAll('#parts-table tbody tr').forEach(r => r.classList.remove('highlight')); 
            if (!forceOn && currentlyHighlightedCall === callNumToHighlight) { currentlyHighlightedCall = null; } 
            else { currentlyHighlightedCall = callNumToHighlight; } 
            if (currentlyHighlightedCall !== null && currentlyHighlightedCall !== undefined && currentlyHighlightedCall !== "") { 
                const callouts = document.querySelectorAll(`.callout[data-call="${currentlyHighlightedCall}"]`); 
                const rows = document.querySelectorAll(`#parts-table tbody tr[data-call="${currentlyHighlightedCall}"]`); 
                callouts.forEach(c => c.classList.add('active')); 
                rows.forEach(r => r.classList.add('highlight')); 
                const row = document.querySelector(`#parts-table tbody tr[data-call="${currentlyHighlightedCall}"]`); 
                if (row) row.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); 
            } 
        }

        function highlightFromUrl() { const params = new URLSearchParams(window.location.search); const highlightCall = params.get('highlight'); highlightElements(highlightCall, true); }
        
        function loadPartsAndDiagram() { 
            const urlParams = new URLSearchParams(window.location.search); 
            const brandCode = urlParams.get('brand'); 
            const modelCode = urlParams.get('model'); 
            const sectionCode = urlParams.get('section'); 
            const subsectionCode = urlParams.get('subsection'); 
            const detailCode = urlParams.get('detail'); 
            if (!(brandCode && modelCode && sectionCode && detailCode)) return; 
            let fileSegment = subsectionCode ? `${sectionCode}_${subsectionCode}_${detailCode}` : `${sectionCode}_${detailCode}`; 
            const partsFile = `${rootPath}data/brands/${brandCode}/${modelCode}/parts_${fileSegment}.json`; 
            fetch(partsFile)
                .then(resp => { if (!resp.ok) { throw new Error(`HTTP error! status: ${resp.status} for ${partsFile}`); } return resp.json(); })
                .then(partsData => { window.currentPartsData = partsData; renderPartsTable(partsData); renderCallouts(partsData); requestAnimationFrame(highlightFromUrl); })
                .catch(error => { document.getElementById('error-message').textContent = `Could not load data for this diagram. Error: ${error.message}`; document.getElementById('error-message').style.display = 'block'; }); 
        }

        function setDiagramImage() { 
            const urlParams = new URLSearchParams(window.location.search); 
            const brandCode = urlParams.get('brand'); 
            const modelCode = urlParams.get('model'); 
            const sectionCode = urlParams.get('section'); 
            const subsectionCode = urlParams.get('subsection'); 
            const detailCode = urlParams.get('detail'); 
            if (brandCode && modelCode && sectionCode && detailCode) { 
                let diagramFileSegment = subsectionCode ? `${sectionCode}-${subsectionCode}-${detailCode}` : `${sectionCode}-${detailCode}`; 
                const diagramFile = `${diagramFileSegment}.png`; 
                diagram.src = `${rootPath}data/brands/${brandCode}/${modelCode}/diagrams/${diagramFile}`; 
            } 
        }
        
        if (document.getElementById('zoom-in')) document.getElementById('zoom-in').onclick = () => { scale = Math.min(scale + 0.2, 5); applyTransform(); };
        if (document.getElementById('zoom-out')) document.getElementById('zoom-out').onclick = () => { scale = Math.max(scale - 0.2, 0.2); applyTransform(); };
        if (document.getElementById('reset')) document.getElementById('reset').onclick = () => { scale = 1; panX = 0; panY = 0; applyTransform(); };
        if (diagramWrapper) {
            diagramWrapper.addEventListener('mousedown', (e) => { isDragging = true; diagramWrapper.classList.add("dragging"); lastMouseX = e.clientX; lastMouseY = e.clientY;});
            window.addEventListener('mouseup', () => { if (isDragging) { isDragging = false; diagramWrapper.classList.remove("dragging"); }});
            window.addEventListener('mousemove', (e) => { if (!isDragging) return; panX += e.clientX - lastMouseX; panY += e.clientY - lastMouseY; lastMouseX = e.clientX; lastMouseY = e.clientY; applyTransform(); });
            diagramWrapper.addEventListener('wheel', function(e) { e.preventDefault(); const zoomSpeed = 0.18; let newScale = scale * (e.deltaY < 0 ? 1 + zoomSpeed : 1 - zoomSpeed); newScale = clamp(newScale, 0.2, 5); const containerRect = diagramContainer.getBoundingClientRect(); const mouseX = e.clientX - containerRect.left; const mouseY = e.clientY - containerRect.top; const xRel = (mouseX - panX) / scale; const yRel = (mouseY - panY) / scale; panX = mouseX - xRel * newScale; panY = mouseY - yRel * newScale; scale = newScale; applyTransform(); }, { passive: false });
        }
        if (diagram) {
            diagram.addEventListener('dragstart', e => e.preventDefault());
            diagram.onload = function() { scale = 1; panX = 0; panY = 0; applyTransform(); loadPartsAndDiagram(); };
        }
        window.addEventListener('resize', () => { applyTransform(); if (window.currentPartsData) { renderCallouts(window.currentPartsData); if (currentlyHighlightedCall) { requestAnimationFrame(() => { highlightElements(currentlyHighlightedCall, true); }); } } });
        
        setDiagramImage(); 
        if (diagram && diagram.complete && diagram.naturalWidth > 0) { diagram.onload(); }

        const toggleBtn = document.getElementById('toggle-coord-picker');
        if (toggleBtn) {
            let coordPickerActive = false; let coordPickerHandler = null; 
            toggleBtn.onclick = function() { 
                coordPickerActive = !coordPickerActive; 
                if (coordPickerActive) { 
                    diagram.style.cursor = "crosshair"; 
                    if (!coordPickerHandler) { 
                        coordPickerHandler = function(e) { e.preventDefault(); e.stopPropagation(); if (e.target !== diagram) return; const wrapper = document.getElementById('diagram-wrapper'); const wrapperRect = wrapper.getBoundingClientRect(); const wrapperWidth = wrapper.clientWidth; const wrapperHeight = wrapper.clientHeight; const imgAspect = diagram.naturalWidth / diagram.naturalHeight; const boxAspect = wrapperWidth / wrapperHeight; let drawWidth, drawHeight, offsetX, offsetY; if (imgAspect > boxAspect) { drawWidth = wrapperWidth; drawHeight = wrapperWidth / imgAspect; offsetX = 0; offsetY = (wrapperHeight - drawHeight) / 2; } else { drawWidth = wrapperHeight * imgAspect; drawHeight = wrapperHeight; offsetX = (wrapperWidth - drawWidth) / 2; offsetY = 0; } const clickX = e.clientX - wrapperRect.left - offsetX; const clickY = e.clientY - wrapperRect.top - offsetY; if (clickX < 0 || clickY < 0 || clickX > drawWidth || clickY > drawHeight) return; const natX = Math.round((clickX / drawWidth) * diagram.naturalWidth); const natY = Math.round((clickY / drawHeight) * diagram.naturalHeight); const jsonSnippet = `"x": ${natX}, "y": ${natY},`; if (navigator.clipboard) { navigator.clipboard.writeText(jsonSnippet).then(() => { alert(jsonSnippet + "\n\nCopied to clipboard!"); }); } else { alert(jsonSnippet + "\n\n(Could not auto-copy. Please copy manually.)"); } console.log(jsonSnippet); if (window.currentPartsData) renderCallouts(window.currentPartsData); highlightElements(currentlyHighlightedCall); }; 
                    } 
                    diagram.addEventListener('click', coordPickerHandler); 
                    toggleBtn.textContent = "Disable Coord Picker"; 
                } else { 
                    diagram.style.cursor = ""; 
                    if (coordPickerHandler) diagram.removeEventListener('click', coordPickerHandler); 
                    toggleBtn.textContent = "Enable Coord Picker"; 
                } 
            }; 
            toggleBtn.textContent = "Enable Coord Picker";
        }
        const modal = document.getElementById('details-modal');
        if (modal) {
            const closeBtn = document.getElementById('close-details-modal'); 
            if (closeBtn) { closeBtn.onclick = function(e) { e.stopPropagation(); modal.style.display = 'none'; }; } 
            modal.onclick = function(e) { if (e.target === modal) modal.style.display = 'none'; }; 
            document.addEventListener('keydown', function(e) { if (e.key === "Escape") modal.style.display = 'none'; });
        }
        
        // Set initial theme
        setTheme(localStorage.getItem('theme'));
    });
</script>

</body>
</html>